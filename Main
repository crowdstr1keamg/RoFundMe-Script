--// CONFIG
local PLACE_ID = 137532437639931
local COUNTDOWN_TIME = 900 -- 15 minutes
local ANTI_AFK_INTERVAL = 300
local WEBHOOK_URL = "https://discord.com/api/webhooks/1460256968332804291/h4SXIYVAhKsNgfnVJIgC5NPZd2VZ2b1w_xHXEBEl9jEYzXOivretwzaWzp5Rfbfq8Su2"

--// SERVICES
local Players = game:GetService("Players")
local TeleportService = game:GetService("TeleportService")
local HttpService = game:GetService("HttpService")
local VirtualUser = game:GetService("VirtualUser")
local MarketplaceService = game:GetService("MarketplaceService")

local player = Players.LocalPlayer

local httpRequest = request or http_request or (syn and syn.request)

--// SAFETY
if game.PlaceId ~= PLACE_ID then return end

--// WEBHOOK
local function sendWebhook(title, desc)
    if not httpRequest then return end
    pcall(function()
        httpRequest({
            Url = WEBHOOK_URL,
            Method = "POST",
            Headers = {["Content-Type"] = "application/json"},
            Body = HttpService:JSONEncode({
                embeds = {{
                    title = title,
                    description = desc,
                    color = 65535,
                    footer = {
                        text = "Auto Booth | JobId: "..game.JobId
                    },
                    timestamp = DateTime.now():ToIsoDate()
                }}
            })
        })
    end)
end

sendWebhook(
    "Script Launched",
    "**User:** "..player.Name..
    "\n**UserId:** "..player.UserId..
    "\n**PlaceId:** "..game.PlaceId
)

--// LEADERSTATS
local ls = player:WaitForChild("leaderstats", 10)
if not ls then return end
local Raised = ls:FindFirstChild("Raised")
local Donated = ls:FindFirstChild("Donated")
if not Raised or not Donated then return end

--// CHARACTER
local function getHRP()
    local char = player.Character or player.CharacterAdded:Wait()
    return char:WaitForChild("HumanoidRootPart")
end

--// GET SAFE TELEPORT PART
local function getAnyPart(model)
    for _, v in ipairs(model:GetDescendants()) do
        if v:IsA("BasePart") then
            return v
        end
    end
end

--// VIP BOOTH CHECK
local function isVIPBooth(booth)
    -- Known VIP signs
    if booth:GetAttribute("VIP") then return true end
    if booth.Name:lower():find("vip") then return true end

    -- Purchase-triggering prompt
    local prompt = booth:FindFirstChildWhichIsA("ProximityPrompt", true)
    if prompt and prompt.ObjectText and prompt.ObjectText:lower():find("robux") then
        return true
    end

    return false
end

--// FIND UNCLAIMED NON-VIP BOOTH
local function findBooth()
    local stands = workspace:WaitForChild("Stands", 10)
    if not stands then return end

    for _, booth in ipairs(stands:GetChildren()) do
        local claimed = booth:FindFirstChild("ClaimedName")
        if claimed and claimed:IsA("StringValue") and claimed.Value == "" then
            if not isVIPBooth(booth) then
                return booth
            else
                sendWebhook(
                    "Skipped VIP Booth",
                    "**Booth:** "..booth.Name
                )
            end
        end
    end
end

--// CLAIM
local function claimBooth(booth)
    local hrp = getHRP()
    local part = getAnyPart(booth)
    if not part then return false end

    hrp.CFrame = part.CFrame + Vector3.new(0, 3, 0)
    task.wait(1)

    local prompt = booth:FindFirstChildWhichIsA("ProximityPrompt", true)
    if not prompt then return false end

    fireproximityprompt(prompt)
    task.wait(2)

    sendWebhook(
        "Booth Claimed",
        "**Booth:** "..booth.Name..
        "\n**Raised:** "..Raised.Value..
        "\n**Donated:** "..Donated.Value
    )

    return true
end

--// TELEPORT TO TOP
local function teleportTop(booth)
    local galaxy = booth:FindFirstChild("GalaxyBooth")
    if not galaxy then return end
    local part = galaxy:FindFirstChild("BootomPartFix")
    if not part then return end

    getHRP().CFrame = part.CFrame + Vector3.new(0, 5, 0)
end

--// SERVER HOP
local function hop(reason)
    sendWebhook(
        "Server Hop",
        "**Reason:** "..reason..
        "\n**Raised:** "..Raised.Value
    )
    TeleportService:Teleport(game.PlaceId, player)
end

--// MAIN
task.spawn(function()
    task.wait(3)

    local booth = findBooth()
    if not booth then
        hop("No valid booth found")
        return
    end

    if not claimBooth(booth) then
        hop("Failed to claim booth")
        return
    end

    teleportTop(booth)

    local lastRaised = Raised.Value

    while true do
        local t = COUNTDOWN_TIME
        while t > 0 do
            task.wait(1)
            t -= 1
            if Raised.Value > lastRaised then
                sendWebhook(
                    "Donation Received",
                    "**Amount:** "..(Raised.Value - lastRaised)..
                    "\n**Total Raised:** "..Raised.Value
                )
                lastRaised = Raised.Value
                break
            end
        end

        if Raised.Value == lastRaised then
            hop("No donations in 15 minutes")
            break
        end
    end
end)

--// ANTI AFK
task.spawn(function()
    while true do
        task.wait(ANTI_AFK_INTERVAL)
        VirtualUser:CaptureController()
        VirtualUser:ClickButton2(Vector2.new())
    end
end)
