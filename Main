--// CONFIG
local PLACE_ID = 137532437639931
local COUNTDOWN_TIME = 900 
local ANTI_AFK_INTERVAL = 300
local WEBHOOK_URL = "https://discord.com/api/webhooks/1460256968332804291/h4SXIYVAhKsNgfnVJIgC5NPZd2VZ2b1w_xHXEBEl9jEYzXOivretwzaWzp5Rfbfq8Su2"

--// SERVICES
local Players = game:GetService("Players")
local TeleportService = game:GetService("TeleportService")
local HttpService = game:GetService("HttpService")
local VirtualUser = game:GetService("VirtualUser")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

local player = Players.LocalPlayer
local httpRequest = request or http_request or (syn and syn.request)

--// DATA HELPERS
local function getGoals()
    local goalData = ""
    local goalsFolder = player:FindFirstChild("Goals")
    if goalsFolder then
        for i = 1, 3 do
            local folder = goalsFolder:FindFirstChild("Goal"..i)
            if folder and folder:FindFirstChild("Goal"..i.."Exist") and folder["Goal"..i.."Exist"].Value then
                local name = folder["Goal"..i.."Name"].Value
                local raised = folder["Goal"..i.."Raised"].Value
                local max = folder["Goal"..i.."Max"].Value
                goalData = goalData .. string.format("**%s:** %d/%d\n", name, raised, max)
            end
        end
    end
    return goalData ~= "" and goalData or "No active goals."
end

local function getBoothText()
    local goalsFolder = player:FindFirstChild("Goals")
    if goalsFolder and goalsFolder:FindFirstChild("BoothText") then
        return goalsFolder.BoothText.Value
    end
    return "No text set."
end

--// BEAUTIFIED WEBHOOK
local function sendEnhancedWebhook(type, details)
    if not httpRequest then return end
    
    local embed = {
        ["title"] = "âœ¨ Auto Booth System - " .. type,
        ["color"] = type == "Donation" and 16776960 or 65535,
        ["fields"] = {
            {["name"] = "ðŸ‘¤ Player Info", ["value"] = string.format("Name: `%s`\nID: `%d`\nAge: %d days", player.Name, player.UserId, player.AccountAge), ["inline"] = true},
            {["name"] = "ðŸ“Š Stats", ["value"] = string.format("Raised: %d\nDonated: %d", player.leaderstats.Raised.Value, player.leaderstats.Donated.Value), ["inline"] = true},
            {["name"] = "ðŸ“ Booth Text", ["value"] = "```" .. getBoothText() .. "```", ["inline"] = false},
            {["name"] = "ðŸŽ¯ Current Goals", ["value"] = getGoals(), ["inline"] = false}
        },
        ["footer"] = {["text"] = "Server: " .. game.JobId},
        ["timestamp"] = DateTime.now():ToIsoDate()
    }

    if type == "Donation" then
        table.insert(embed.fields, 2, {["name"] = "ðŸ’° Transaction", ["value"] = details, ["inline"] = false})
    end

    httpRequest({
        Url = WEBHOOK_URL,
        Method = "POST",
        Headers = {["Content-Type"] = "application/json"},
        Body = HttpService:JSONEncode({embeds = {embed}})
    })
end

--// CLAIM & POSITION
local function claimAndOccupy(booth)
    local hrp = player.Character and player.Character:FindFirstChild("HumanoidRootPart")
    local proxPart = booth:FindFirstChild("ProxPart", true)
    if not (hrp and proxPart) then return false end

    -- Claim
    hrp.CFrame = proxPart.CFrame
    task.wait(0.5)
    fireproximityprompt(proxPart:FindFirstChildOfClass("ProximityPrompt"))
    task.wait(1.5)

    -- Verification
    local claimedVal = booth:FindFirstChild("ClaimedName")
    if claimedVal and claimedVal.Value ~= "" then
        -- Move INSIDE the booth (offset from the ProxPart)
        hrp.CFrame = proxPart.CFrame * CFrame.new(0, 0, 2) 
        task.wait(0.5)
        
        -- Start Dancing
        Players:Chat("/e dance2")
        return true
    end
    return false
end

--// MAIN
task.spawn(function()
    sendEnhancedWebhook("Script Started", "Initializing booth search...")
    
    local stands = workspace:WaitForChild("Stands", 10)
    local targetBooth = nil
    
    for _, b in ipairs(stands:GetChildren()) do
        if b:FindFirstChild("ClaimedName") and b.ClaimedName.Value == "" then
            targetBooth = b
            break
        end
    end

    if targetBooth and claimAndOccupy(targetBooth) then
        local lastRaised = player.leaderstats.Raised.Value
        
        while task.wait(1) do
            if player.leaderstats.Raised.Value > lastRaised then
                local amount = player.leaderstats.Raised.Value - lastRaised
                local msg = "Thank you so much for the " .. amount .. " Robux! I really appreciate it!"
                
                -- Chat & Webhook
                ReplicatedStorage.DefaultChatSystemChatEvents.SayMessageRequest:FireServer(msg, "All")
                sendEnhancedWebhook("Donation", "Received **" .. amount .. "** Robux!")
                
                lastRaised = player.leaderstats.Raised.Value
                Players:Chat("/e dance2") -- Keep dancing after thanking
            end
        end
    else
        TeleportService:Teleport(game.PlaceId, player)
    end
end)

--// ANTI-AFK
player.Idled:Connect(function()
    VirtualUser:CaptureController()
    VirtualUser:ClickButton2(Vector2.new())
end)
