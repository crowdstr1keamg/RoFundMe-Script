--[[
     RoFundMe - Script V1.2
     Put into delta/autoexecute folder to work autonomously.
]]

--// DELAY
if not game:IsLoaded() then game.Loaded:Wait() end
task.wait(10)

--// SERVICES
local Players = game:GetService("Players")
local HttpService = game:GetService("HttpService")
local TeleportService = game:GetService("TeleportService")
local TextChatService = game:GetService("TextChatService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local VirtualInputManager = game:GetService("VirtualInputManager")

--// VARIABLES
local player = Players.LocalPlayer
local sessionRaised = 0
local hopTimer = 600
local lastRaisedValue = 0
local blacklistedBooths = {}
local isBoothClaimed = false -- The "State Lock"
local httpRequest = (syn and syn.request) or (http and http.request) or http_request or (fluxus and fluxus.request) or request

--// DATA SCRAPER
local function getUltraData()
    local data = {Goals = {}, BoothText = "No Text Set"}
    local goalsFolder = player:FindFirstChild("Goals")
    if goalsFolder then
        data.BoothText = goalsFolder:FindFirstChild("BoothText") and goalsFolder.BoothText.Value or data.BoothText
        for i = 1, 3 do
            local g = goalsFolder:FindFirstChild("Goal"..i)
            if g and g:FindFirstChild("Goal"..i.."Exist") and g["Goal"..i.."Exist"].Value then
                table.insert(data.Goals, {
                    name = g["Goal"..i.."Name"].Value or "Goal "..i,
                    current = g["Goal"..i.."Raised"].Value or 0,
                    max = g["Goal"..i.."Max"].Value or 0
                })
            end
        end
    end
    return data
end

--// WEBHOOK
local function sendUltraWebhook(title, color)
    if not httpRequest then return end
    local stats = getUltraData()
    local fields = {
        {["name"] = "üë§ Player", ["value"] = player.Name, ["inline"] = true},
        {["name"] = "üìà Session", ["value"] = sessionRaised .. " R$", ["inline"] = true},
        {["name"] = "üìù Booth Message", ["value"] = "```" .. stats.BoothText .. "```", ["inline"] = false}
    }
    for _, goal in ipairs(stats.Goals) do
        table.insert(fields, {["name"] = "üéØ " .. goal.name, ["value"] = goal.current .. " / " .. goal.max, ["inline"] = true})
    end
    pcall(function()
        httpRequest({
            Url = "https://discord.com/api/webhooks/1460256968332804291/h4SXIYVAhKsNgfnVJIgC5NPZd2VZ2b1w_xHXEBEl9jEYzXOivretwzaWzp5Rfbfq8Su2",
            Method = "POST",
            Headers = {["Content-Type"] = "application/json"},
            Body = HttpService:JSONEncode({
                ["embeds"] = {{
                    ["title"] = "üíé GemFund Ultra | " .. title,
                    ["color"] = color,
                    ["fields"] = fields,
                    ["footer"] = {["text"] = "Server: " .. game.JobId},
                    ["timestamp"] = DateTime.now():ToIsoDate()
                }}
            })
        })
    end)
end

--// UI SETUP
local sg = Instance.new("ScreenGui", player:WaitForChild("PlayerGui"))
sg.Name = "GemFundUI"; sg.ResetOnSpawn = false
local frame = Instance.new("Frame", sg)
frame.Size = UDim2.new(0, 240, 0, 110); frame.Position = UDim2.new(1, -250, 1, -120); frame.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
Instance.new("UICorner", frame)
local stroke = Instance.new("UIStroke", frame); stroke.Color = Color3.fromRGB(0, 200, 255); stroke.Thickness = 2

local function createLabel(text, y, color)
    local l = Instance.new("TextLabel", frame); l.Size = UDim2.new(1, -20, 0, 20); l.Position = UDim2.new(0, 10, 0, y); l.BackgroundTransparency = 1
    l.Text = text; l.TextColor3 = color or Color3.new(1,1,1); l.Font = Enum.Font.GothamBold; l.TextSize = 13; l.TextXAlignment = Enum.TextXAlignment.Left
    return l
end
local titleLbl = createLabel("üíé GEMFUND ULTRA V1.1", 10, Color3.fromRGB(0, 200, 255))
local timerLbl = createLabel("Next Hop: 10:00", 35)
local raisedLbl = createLabel("Raised: 0 R$", 55, Color3.fromRGB(0, 255, 120))
local statusLbl = createLabel("Status: Booting...", 75, Color3.fromRGB(200, 200, 200))

--// TIMER LOOP
task.spawn(function()
    while task.wait(1) do
        hopTimer = hopTimer - 1
        timerLbl.Text = string.format("Next Hop: %02d:%02d", math.floor(hopTimer/60), hopTimer%60)
        if hopTimer <= 0 then TeleportService:Teleport(137532437639931, player); break end
    end
end)

--// AGGRESSIVE PROXIMITY SENSOR (5 STUDS)
task.spawn(function()
    while task.wait(0.3) do
        if not isBoothClaimed and player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
            for _, v in pairs(workspace:GetDescendants()) do
                if v:IsA("ProximityPrompt") and v.Enabled then
                    local pPart = v.Parent:IsA("BasePart") and v.Parent or v.Parent:FindFirstChildWhichIsA("BasePart")
                    if pPart and (player.Character.HumanoidRootPart.Position - pPart.Position).Magnitude <= 5 then
                        VirtualInputManager:SendKeyEvent(true, v.KeyboardKeyCode, false, game)
                        task.wait(v.HoldDuration + 0.1)
                        VirtualInputManager:SendKeyEvent(false, v.KeyboardKeyCode, false, game)
                    end
                end
            end
        end
    end
end)

--// BOOTH OWNERSHIP CHECK
local function checkOwnBooth()
    local stands = workspace:FindFirstChild("Stands") or workspace:FindFirstChild("Booths")
    if not stands then return false end
    for _, booth in pairs(stands:GetChildren()) do
        local owner = booth:FindFirstChild("ClaimedName")
        if owner and (owner.Value == player.Name or owner.Value == player.DisplayName) then
            return true
        end
    end
    return false
end

--// BOOTH SEEKER (DENSITY BASED)
local function getBestBooth()
    local stands = workspace:FindFirstChild("Stands") or workspace:FindFirstChild("Booths")
    if not stands then return nil end
    local best, maxDensity = nil, -1
    for _, booth in pairs(stands:GetChildren()) do
        if not blacklistedBooths[booth] then
            local owner = booth:FindFirstChild("ClaimedName")
            if owner and (owner.Value == "" or owner.Value == nil) then
                local pPart = booth:FindFirstChild("ProxPart", true) or booth.PrimaryPart
                local density = 0
                for _, p in pairs(Players:GetPlayers()) do
                    if p ~= player and p.Character and (p.Character.HumanoidRootPart.Position - pPart.Position).Magnitude < 45 then 
                        density = density + 1 
                    end
                end
                if density > maxDensity then maxDensity = density; best = booth end
            end
        end
    end
    return best
end

--// MAIN SYSTEM
task.spawn(function()
    local ls = player:WaitForChild("leaderstats", 60)
    local raised = ls:WaitForChild("Raised")
    lastRaisedValue = raised.Value
    sendUltraWebhook("Script Initialized", 16777215)
    
    -- Check if already claimed on join
    if checkOwnBooth() then
        isBoothClaimed = true
        statusLbl.Text = "Status: Secured (Existing)"
    else
        -- Seeking Loop
        while not isBoothClaimed do
            statusLbl.Text = "Status: Seeking Booth..."
            local target = getBestBooth()
            if target then
                local pPart = target:FindFirstChild("ProxPart", true) or target.PrimaryPart
                player.Character.HumanoidRootPart.CFrame = pPart.CFrame
                
                local startTime = os.time()
                while os.time() - startTime < 10 do
                    statusLbl.Text = "Status: Claiming (" .. (10 - (os.time() - startTime)) .. "s)"
                    task.wait(1)
                    if checkOwnBooth() then 
                        isBoothClaimed = true 
                        break 
                    end
                end
                
                if not isBoothClaimed then
                    blacklistedBooths[target] = true
                    statusLbl.Text = "Status: Failed, Blacklisting..."
                    task.wait(1)
                end
            else
                statusLbl.Text = "Status: No Booths. Hopping..."
                task.wait(2)
                TeleportService:Teleport(137532437639931, player)
                return
            end
        end
    end

    -- SUCCESS LOCK
    if isBoothClaimed then
        statusLbl.Text = "Status: Secured"
        sendUltraWebhook("Booth Secured", 3066993)
        TextChatService.TextChannels.RBXGeneral:SendAsync("/e dance2")
        -- Final position adjust
        task.wait(1)
        player.Character.HumanoidRootPart.CFrame = player.Character.HumanoidRootPart.CFrame * CFrame.new(0, 0, 3)
    end

    raised.Changed:Connect(function(val)
        local gained = val - lastRaisedValue
        if gained > 0 then
            sessionRaised = sessionRaised + gained
            lastRaisedValue = val
            raisedLbl.Text = "Raised: " .. sessionRaised .. " R$"
            hopTimer = 600
            TextChatService.TextChannels.RBXGeneral:SendAsync("Thank you so much for the " .. gained .. " Robux!")
            sendUltraWebhook("Donation Received!", 16776960)
        end
    end)
end)

-- Anti-AFK
player.Idled:Connect(function()
    game:GetService("VirtualUser"):CaptureController()
    game:GetService("VirtualUser"):ClickButton2(Vector2.new())
end)
