--[[
    üíé GEMFUND ULTRA V1.2 (Stable)
    - Fix: Added nil-checks for Goals folder to prevent crashing.
    - Fix: Re-coded Timer for high precision.
    - Fix: Universal Webhook handler (Array-safe).
]]

--// CONFIGURATION
local CONFIG = {
    Webhook = "https://discord.com/api/webhooks/1460256968332804291/h4SXIYVAhKsNgfnVJIgC5NPZd2VZ2b1w_xHXEBEl9jEYzXOivretwzaWzp5Rfbfq8Su2",
    PlaceID = 137532437639931,
    Countdown = 900, -- 15 Minutes
    LowGraphics = true,
    Messages = {
        "Thank you so much for the %d Robux!",
        "Legend! Thanks for the %d!",
        "I really appreciate the %d Robux donation!"
    }
}

--// SERVICES
local Players = game:GetService("Players")
local HttpService = game:GetService("HttpService")
local TeleportService = game:GetService("TeleportService")
local TextChatService = game:GetService("TextChatService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

--// VARIABLES
local player = Players.LocalPlayer
local sessionRaised = 0
local startTime = os.time()
local hopTimeLeft = CONFIG.Countdown
local lastRaisedValue = 0

--// WEBHOOK SENDER (FIXED & IMPROVED)
local function sendWebhook(title, color)
    local request = (syn and syn.request) or (http and http.request) or http_request or request
    if not request then return end

    -- Safe Data Collection
    local goalsFolder = player:FindFirstChild("Goals")
    local boothText = (goalsFolder and goalsFolder:FindFirstChild("BoothText")) and goalsFolder.BoothText.Value or "No custom text"
    
    local fields = {
        {["name"] = "üë§ Player", ["value"] = "`" .. player.Name .. "`", ["inline"] = true},
        {["name"] = "üìà Session", ["value"] = "**" .. sessionRaised .. " R$**", ["inline"] = true},
        {["name"] = "üìù Booth", ["value"] = "```" .. boothText .. "```", ["inline"] = false}
    }

    -- Add Goals only if they exist
    if goalsFolder then
        for i = 1, 3 do
            local g = goalsFolder:FindFirstChild("Goal"..i)
            if g and g:FindFirstChild("Goal"..i.."Exist") and g["Goal"..i.."Exist"].Value == true then
                table.insert(fields, {
                    ["name"] = "üéØ " .. (g["Goal"..i.."Name"].Value or "Goal"),
                    ["value"] = string.format("`%d / %d`", g["Goal"..i.."Raised"].Value, g["Goal"..i.."Max"].Value),
                    ["inline"] = true
                })
            end
        end
    end

    local payload = HttpService:JSONEncode({
        ["embeds"] = {{
            ["title"] = "üíé GemFund Ultra | " .. title,
            ["color"] = color,
            ["fields"] = fields,
            ["footer"] = {["text"] = "Server: " .. game.JobId},
            ["timestamp"] = DateTime.now():ToIsoDate(),
            ["thumbnail"] = {["url"] = "https://www.roblox.com/headshot-thumbnail/image?userId="..player.UserId.."&width=420&height=420&format=png"}
        }}
    })

    pcall(function()
        request({Url = CONFIG.Webhook, Method = "POST", Headers = {["Content-Type"] = "application/json"}, Body = payload})
    end)
end

--// UI SETUP (FIXED)
local sg = Instance.new("ScreenGui", player:WaitForChild("PlayerGui"))
sg.Name = "GemFundUI"
sg.ResetOnSpawn = false

local main = Instance.new("Frame", sg)
main.Size = UDim2.new(0, 220, 0, 100)
main.Position = UDim2.new(1, -230, 1, -110)
main.BackgroundColor3 = Color3.fromRGB(15, 15, 15)
Instance.new("UICorner", main)
Instance.new("UIStroke", main).Color = Color3.fromRGB(0, 180, 255)

local timerLbl = Instance.new("TextLabel", main)
timerLbl.Size = UDim2.new(1, 0, 0, 40)
timerLbl.Position = UDim2.new(0,0,0,10)
timerLbl.Text = "Loading Timer..."
timerLbl.TextColor3 = Color3.new(1,1,1)
timerLbl.BackgroundTransparency = 1
timerLbl.Font = Enum.Font.GothamBold

local raisedLbl = Instance.new("TextLabel", main)
raisedLbl.Size = UDim2.new(1, 0, 0, 30)
raisedLbl.Position = UDim2.new(0,0,0,50)
raisedLbl.Text = "Session: 0 R$"
raisedLbl.TextColor3 = Color3.fromRGB(0, 255, 100)
raisedLbl.BackgroundTransparency = 1

--// SMART CLUSTER BOOTH FINDER
local function findAndClaim()
    local stands = workspace:FindFirstChild("Stands") or workspace:FindFirstChild("Booths")
    if not stands then return end

    local bestBooth = nil
    local maxDensity = -1

    for _, b in pairs(stands:GetChildren()) do
        local claimed = b:FindFirstChild("ClaimedName")
        if claimed and (claimed.Value == "" or claimed.Value == nil) then
            -- Count nearby players
            local nearby = 0
            for _, p in pairs(Players:GetPlayers()) do
                if p ~= player and p.Character and p.Character:FindFirstChild("HumanoidRootPart") then
                    if (p.Character.HumanoidRootPart.Position - b.PrimaryPart.Position).Magnitude < 40 then
                        nearby = nearby + 1
                    end
                end
            end

            if nearby > maxDensity then
                maxDensity = nearby
                bestBooth = b
            end
        end
    end

    if bestBooth and player.Character then
        local hrp = player.Character:WaitForChild("HumanoidRootPart")
        hrp.CFrame = bestBooth.PrimaryPart.CFrame
        task.wait(0.5)
        local prompt = bestBooth:FindFirstChildOfClass("ProximityPrompt", true)
        if prompt then fireproximityprompt(prompt) end
        
        -- Position slightly away from sign facing forward
        task.wait(1)
        hrp.CFrame = bestBooth.PrimaryPart.CFrame * CFrame.new(0, 0, 3)
        
        -- Animation
        if TextChatService.ChatVersion == Enum.ChatVersion.TextChatService then
            TextChatService.TextChannels.RBXGeneral:SendAsync("/e dance2")
        else
            ReplicatedStorage.DefaultChatSystemChatEvents.SayMessageRequest:FireServer("/e dance2", "All")
        end
        sendWebhook("Joined & Claimed", 65280)
    end
end

--// MAIN EXECUTION
task.spawn(function()
    local ls = player:WaitForChild("leaderstats", 20)
    local raised = ls:WaitForChild("Raised")
    lastRaisedValue = raised.Value

    findAndClaim()

    -- Donation Watcher
    raised.Changed:Connect(function(newVal)
        local diff = newVal - lastRaisedValue
        if diff > 0 then
            sessionRaised = sessionRaised + diff
            lastRaisedValue = newVal
            raisedLbl.Text = "Session: " .. sessionRaised .. " R$"
            
            -- Say thanks
            local msg = CONFIG.Messages[math.random(1, #CONFIG.Messages)]
            TextChatService.TextChannels.RBXGeneral:SendAsync(string.format(msg, diff))
            
            sendWebhook("Donation Received! üí∏", 16776960)
            hopTimeLeft = CONFIG.Countdown -- Reset timer on donation
        end
    end)

    -- Precision Timer Loop
    while task.wait(1) do
        hopTimeLeft = hopTimeLeft - 1
        local m = math.floor(hopTimeLeft / 60)
        local s = hopTimeLeft % 60
        timerLbl.Text = string.format("Next Hop: %02d:%02d", m, s)
        
        if hopTimeLeft <= 0 then
            sendWebhook("Server Hopping...", 16711680)
            TeleportService:Teleport(CONFIG.PlaceID, player)
            break
        end
    end
end)

-- Anti-AFK
player.Idled:Connect(function()
    game:GetService("VirtualUser"):CaptureController()
    game:GetService("VirtualUser"):ClickButton2(Vector2.new())
end)
