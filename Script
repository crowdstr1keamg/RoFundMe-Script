--[[
    üíé GEMFUND ULTRA V1.1 (Ultimate Edition)
    - Fixes: Restored UI Timer Logic & Webhook Arrays
    - New: Real-time Goal Tracker (Goal1-Goal3)
    - New: Automatic Booth Message Scraper
    - New: Account Age & JobId Logging
]]

--// CONFIGURATION
local CONFIG = {
    Webhook = "https://discord.com/api/webhooks/1460256968332804291/h4SXIYVAhKsNgfnVJIgC5NPZd2VZ2b1w_xHXEBEl9jEYzXOivretwzaWzp5Rfbfq8Su2",
    PlaceID = 137532437639931,
    Countdown = 900, -- 15 Minutes (900 seconds)
    LowGraphics = true,
    AutoDance = "/e dance2",
    Messages = {
        "Thank you so much for the %d Robux!",
        "Legend! Thanks for the %d!",
        "I really appreciate the %d Robux donation!"
    }
}

--// SERVICES
local Players = game:GetService("Players")
local HttpService = game:GetService("HttpService")
local TeleportService = game:GetService("TeleportService")
local TextChatService = game:GetService("TextChatService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")

--// VARIABLES
local player = Players.LocalPlayer
local sessionRaised = 0
local startTime = os.time()
local hopTimeLeft = CONFIG.Countdown
local httpRequest = (syn and syn.request) or (http and http.request) or http_request or (fluxus and fluxus.request) or request

--// GOAL SCRAPER
local function getGoalsData()
    local fields = {}
    local goalsFolder = player:FindFirstChild("Goals")
    if goalsFolder then
        for i = 1, 3 do
            local g = goalsFolder:FindFirstChild("Goal"..i)
            if g and g:FindFirstChild("Goal"..i.."Exist") and g["Goal"..i.."Exist"].Value then
                local name = g["Goal"..i.."Name"].Value or "Goal "..i
                local raised = g["Goal"..i.."Raised"].Value or 0
                local max = g["Goal"..i.."Max"].Value or 100
                table.insert(fields, {
                    ["name"] = "üéØ " .. name,
                    ["value"] = string.format("Progress: `%d / %d`", raised, max),
                    ["inline"] = true
                })
            end
        end
    end
    return fields
end

--// WEBHOOK DISPATCHER (IMAGE STYLE)
local function sendEnhancedWebhook(title, color)
    if not httpRequest then return end
    
    local goals = getGoalsData()
    local boothText = "None"
    if player:FindFirstChild("Goals") and player.Goals:FindFirstChild("BoothText") then
        boothText = player.Goals.BoothText.Value
    end

    local fields = {
        {["name"] = "üë§ Player", ["value"] = string.format("**%s**\n(%d)", player.Name, player.UserId), ["inline"] = true},
        {["name"] = "‚åõ Account Age", ["value"] = player.AccountAge .. " Days", ["inline"] = true},
        {["name"] = "üìà Total Raised", ["value"] = tostring(player.leaderstats.Raised.Value), ["inline"] = true},
        {["name"] = "üìù Booth Message", ["value"] = "```" .. boothText .. "```", ["inline"] = false}
    }
    
    for _, goal in ipairs(goals) do table.insert(fields, goal) end

    local payload = {
        ["embeds"] = {{
            ["title"] = "‚úÖ " .. title,
            ["color"] = color,
            ["fields"] = fields,
            ["footer"] = {["text"] = "GemFund Ultra | JobId: " .. game.JobId},
            ["timestamp"] = DateTime.now():ToIsoDate(),
            ["thumbnail"] = {["url"] = "https://www.roblox.com/headshot-thumbnail/image?userId="..player.UserId.."&width=420&height=420&format=png"}
        }}
    }

    pcall(function()
        httpRequest({
            Url = CONFIG.Webhook,
            Method = "POST",
            Headers = {["Content-Type"] = "application/json"},
            Body = HttpService:JSONEncode(payload)
        })
    end)
end

--// UI SETUP
local sg = Instance.new("ScreenGui", player:WaitForChild("PlayerGui"))
sg.Name = "GemFundUI"
sg.ResetOnSpawn = false

local frame = Instance.new("Frame", sg)
frame.Size = UDim2.new(0, 220, 0, 100)
frame.Position = UDim2.new(1, -230, 1, -110)
frame.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
Instance.new("UICorner", frame).CornerRadius = UDim.new(0, 10)

local title = Instance.new("TextLabel", frame)
title.Size = UDim2.new(1, 0, 0, 30)
title.Text = "üíé GEMFUND ULTRA V1.1"
title.TextColor3 = Color3.fromRGB(0, 255, 150)
title.BackgroundTransparency = 1
title.Font = Enum.Font.GothamBold

local timerLabel = Instance.new("TextLabel", frame)
timerLabel.Size = UDim2.new(1, 0, 0, 30)
timerLabel.Position = UDim2.new(0, 0, 0, 35)
timerLabel.Text = "Next Hop: 15:00"
timerLabel.TextColor3 = Color3.new(1,1,1)
timerLabel.BackgroundTransparency = 1

local raisedLabel = Instance.new("TextLabel", frame)
raisedLabel.Size = UDim2.new(1, 0, 0, 30)
raisedLabel.Position = UDim2.new(0, 0, 0, 60)
raisedLabel.Text = "Session: 0 R$"
raisedLabel.TextColor3 = Color3.new(1,1,1)
raisedLabel.BackgroundTransparency = 1

--// TIMER LOGIC
task.spawn(function()
    while task.wait(1) do
        hopTimeLeft = hopTimeLeft - 1
        local mins = math.floor(hopTimeLeft / 60)
        local secs = hopTimeLeft % 60
        timerLabel.Text = string.format("Next Hop: %02d:%02d", mins, secs)
        
        if hopTimeLeft <= 0 then
            TeleportService:Teleport(CONFIG.PlaceID, player)
            break
        end
    end
end)

--// SMART BOOTH FINDER
local function claimBestBooth()
    local stands = workspace:FindFirstChild("Stands") or workspace:FindFirstChild("Booths")
    local bestStand = nil
    local maxNearby = -1

    for _, s in pairs(stands:GetChildren()) do
        local owner = s:FindFirstChild("ClaimedName")
        if owner and (owner.Value == "" or owner.Value == nil) then
            local count = 0
            for _, p in pairs(Players:GetPlayers()) do
                if p ~= player and p.Character and p.Character:FindFirstChild("HumanoidRootPart") then
                    if (p.Character.HumanoidRootPart.Position - s.PrimaryPart.Position).Magnitude < 45 then
                        count = count + 1
                    end
                end
            end
            if count > maxNearby then
                maxNearby = count
                bestStand = s
            end
        end
    end

    if bestStand then
        local hrp = player.Character:WaitForChild("HumanoidRootPart")
        hrp.CFrame = bestStand.PrimaryPart.CFrame
        task.wait(0.5)
        local prompt = bestStand:FindFirstChildOfClass("ProximityPrompt", true)
        if prompt then fireproximityprompt(prompt) end
        task.wait(2)
        sendEnhancedWebhook("Booth Secured", 3066993)
        TextChatService.TextChannels.RBXGeneral:SendAsync(CONFIG.AutoDance)
    end
end

--// INITIALIZE
task.spawn(claimBestBooth)

player.leaderstats.Raised.Changed:Connect(function(val)
    local gained = val - lastRaised
    if gained > 0 then
        sessionRaised = sessionRaised + gained
        raisedLabel.Text = "Session: " .. sessionRaised .. " R$"
        sendEnhancedWebhook("Donation Received!", 16776960)
    end
end)
