--[[
    ðŸ’Ž GEMFUND ULTRA V1.1 [PROXIMITY & TIMER UPDATE]
    - Fix: Added HoldDuration support for ProximityPrompts.
    - Change: Server hop timer reduced to 10 minutes (600s).
    - Fix: Improved prompt detection logic.
]]

--// CONFIGURATION
local CONFIG = {
    Webhook = "https://discord.com/api/webhooks/1460256968332804291/h4SXIYVAhKsNgfnVJIgC5NPZd2VZ2b1w_xHXEBEl9jEYzXOivretwzaWzp5Rfbfq8Su2",
    PlaceID = 137532437639931,
    Countdown = 600, -- 10 Minutes
    LowGraphics = true,
    Messages = {
        "Thank you so much for the %d Robux!",
        "Legend! Thanks for the %d!",
        "I really appreciate the %d Robux donation!",
        "Whoa! %d! You're the best!"
    }
}

--// SERVICES
local Players = game:GetService("Players")
local HttpService = game:GetService("HttpService")
local TeleportService = game:GetService("TeleportService")
local TextChatService = game:GetService("TextChatService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local VirtualInputManager = game:GetService("VirtualInputManager") -- For precise prompt holding

if not game:IsLoaded() then game.Loaded:Wait() end

local player = Players.LocalPlayer
local sessionRaised = 0
local hopTimer = CONFIG.Countdown
local lastRaisedValue = 0
local httpRequest = (syn and syn.request) or (http and http.request) or http_request or (fluxus and fluxus.request) or request

--// WEBHOOK & DATA (Simplified for speed)
local function sendUltraWebhook(title, color)
    if not httpRequest then return end
    pcall(function()
        httpRequest({
            Url = CONFIG.Webhook,
            Method = "POST",
            Headers = {["Content-Type"] = "application/json"},
            Body = HttpService:JSONEncode({
                ["embeds"] = {{
                    ["title"] = "ðŸ’Ž GemFund Ultra | " .. title,
                    ["color"] = color,
                    ["fields"] = {
                        {["name"] = "ðŸ‘¤ Player", ["value"] = player.Name, ["inline"] = true},
                        {["name"] = "ðŸ“ˆ Session", ["value"] = sessionRaised .. " R$", ["inline"] = true}
                    },
                    ["footer"] = {["text"] = "JobId: " .. game.JobId},
                    ["timestamp"] = DateTime.now():ToIsoDate()
                }}
            })
        })
    end)
end

--// UI SETUP
local sg = Instance.new("ScreenGui", player:WaitForChild("PlayerGui"))
sg.Name = "GemFundUltraUI"; sg.ResetOnSpawn = false
local frame = Instance.new("Frame", sg)
frame.Size = UDim2.new(0, 240, 0, 110); frame.Position = UDim2.new(1, -250, 1, -120); frame.BackgroundColor3 = Color3.fromRGB(20, 20, 20); frame.BorderSizePixel = 0
Instance.new("UICorner", frame)
local stroke = Instance.new("UIStroke", frame); stroke.Color = Color3.fromRGB(0, 200, 255); stroke.Thickness = 2

local function createLabel(text, y, color)
    local l = Instance.new("TextLabel", frame); l.Size = UDim2.new(1, -20, 0, 20); l.Position = UDim2.new(0, 10, 0, y); l.BackgroundTransparency = 1
    l.Text = text; l.TextColor3 = color or Color3.new(1,1,1); l.Font = Enum.Font.GothamBold; l.TextSize = 13; l.TextXAlignment = Enum.TextXAlignment.Left
    return l
end
local titleLbl = createLabel("ðŸ’Ž GEMFUND ULTRA V1.1", 10, Color3.fromRGB(0, 200, 255))
local timerLbl = createLabel("Next Hop: 10:00", 35)
local raisedLbl = createLabel("Raised: 0 R$", 55, Color3.fromRGB(0, 255, 120))
local statusLbl = createLabel("Status: Initializing...", 75, Color3.fromRGB(200, 200, 200))

--// TIMER LOOP
task.spawn(function()
    while task.wait(1) do
        hopTimer = hopTimer - 1
        timerLbl.Text = string.format("Next Hop: %02d:%02d", math.floor(hopTimer/60), hopTimer%60)
        if hopTimer <= 0 then TeleportService:Teleport(CONFIG.PlaceID, player); break end
    end
end)

--// SMART PROXIMITY HOLDER
local function interactWithPrompt(prompt)
    if not prompt then return end
    statusLbl.Text = "Status: Holding Prompt..."
    
    -- Method 1: Key Sim (Most reliable for HoldDuration)
    local keyCode = prompt.KeyboardKeyCode
    VirtualInputManager:SendKeyEvent(true, keyCode, false, game)
    task.wait(prompt.HoldDuration + 0.2)
    VirtualInputManager:SendKeyEvent(false, keyCode, false, game)
    
    -- Method 2: Internal Logic (Fallback)
    fireproximityprompt(prompt)
end

--// BOOTH LOGIC
local function getBestBooth()
    local stands = workspace:FindFirstChild("Stands") or workspace:FindFirstChild("Booths")
    if not stands then return nil end
    local best, maxDensity = nil, -1
    for _, booth in pairs(stands:GetChildren()) do
        local owner = booth:FindFirstChild("ClaimedName")
        if owner and (owner.Value == "" or owner.Value == nil) then
            local pPart = booth:FindFirstChild("ProxPart", true) or booth.PrimaryPart
            local density = 0
            for _, p in pairs(Players:GetPlayers()) do
                if p ~= player and p.Character and p.Character:FindFirstChild("HumanoidRootPart") then
                    if (p.Character.HumanoidRootPart.Position - pPart.Position).Magnitude < 40 then density = density + 1 end
                end
            end
            if density > maxDensity then maxDensity = density; best = booth end
        end
    end
    return best
end

local function claim()
    local booth = getBestBooth()
    if not booth then return false end

    local pPart = booth:FindFirstChild("ProxPart", true) or booth.PrimaryPart
    local prompt = booth:FindFirstChildOfClass("ProximityPrompt", true)
    local hrp = player.Character:WaitForChild("HumanoidRootPart")

    hrp.CFrame = pPart.CFrame
    task.wait(0.5)

    for i = 1, 2 do
        statusLbl.Text = "Status: Claiming Attempt " .. i
        interactWithPrompt(prompt)
        task.wait(2.5)

        local owner = booth:FindFirstChild("ClaimedName")
        if owner and (owner.Value == player.Name or owner.Value == player.DisplayName) then
            hrp.CFrame = pPart.CFrame * CFrame.new(0, 0, 3)
            statusLbl.Text = "Status: Secured & Dancing"
            TextChatService.TextChannels.RBXGeneral:SendAsync("/e dance2")
            return true
        end
    end
    return false
end

--// MAIN
task.spawn(function()
    local ls = player:WaitForChild("leaderstats", 30)
    local raised = ls:WaitForChild("Raised")
    lastRaisedValue = raised.Value
    
    sendUltraWebhook("Script Initialized", 16777215)
    
    if claim() then
        sendUltraWebhook("Booth Secured", 3066993)
        raised.Changed:Connect(function(val)
            local gained = val - lastRaisedValue
            if gained > 0 then
                sessionRaised = sessionRaised + gained
                lastRaisedValue = val
                raisedLbl.Text = "Raised: " .. sessionRaised .. " R$"
                hopTimer = CONFIG.Countdown
                TextChatService.TextChannels.RBXGeneral:SendAsync(string.format(CONFIG.Messages[math.random(1, #CONFIG.Messages)], gained))
                sendUltraWebhook("Donation Received!", 16776960)
            end
        end)
    else
        statusLbl.Text = "Status: No Booths Found. Hopping..."
        task.wait(2)
        TeleportService:Teleport(CONFIG.PlaceID, player)
    end
end)

-- Anti-AFK
player.Idled:Connect(function()
    game:GetService("VirtualUser"):CaptureController()
    game:GetService("VirtualUser"):ClickButton2(Vector2.new())
end)
